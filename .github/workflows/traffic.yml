name: Log Traffic

on:
  schedule:
    - cron: '0 1 * * *'   # runs daily at 01:00 UTC
  workflow_dispatch:      # allows manual run

jobs:
  update-traffic:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Fetch traffic data
        run: |
          mkdir -p traffic
          curl -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/traffic/views \
            > traffic/views.json
          curl -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/traffic/clones \
            > traffic/clones.json

      - name: Append with timestamp
        run: |
          timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "{\"timestamp\": \"$timestamp\", \"data\": $(cat traffic/views.json)}" \
              >> traffic/views_log.jsonl
          echo "{\"timestamp\": \"$timestamp\", \"data\": $(cat traffic/clones.json)}" \
              >> traffic/clones_log.jsonl

      - name: Commit updated logs
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add traffic/views_log.jsonl traffic/clones_log.jsonl
          git commit -m "Update traffic logs" || echo "No changes to commit"
          git push